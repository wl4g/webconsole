<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>XCloud WebConsole</title>
	<meta name="renderer" content="webkit">
	<meta name="force-rendering" content="webkit">
	<link rel="stylesheet" href="css/xterm.css" />
	<script src="js/xterm.js"></script>
	<script src="js/jquery-3.5.1.min.js"></script>
	<script src="js/zmodem/zmodem.devel.js"></script>
	<script src="js/myzmodem.js"></script>
</head>
<body>
	Welcome to XCloud WebConsole !
	<button onclick="openAdd()">ADD</button>
	<button onclick="openSession()">Sessions</button>

	<div id="add" hidden>
		<label for="alias">Alias:</label><input id="alias"/><br>
		<label for="address">Address:</label><input id="address"/><br>
		<label for="username">Username:</label><input id="username"/><br>

		<label><input name="type" type="radio" value="1" onchange="changeType(1)"/>密码</label>
		<label><input name="type" type="radio" value="2" onchange="changeType(2)"/>密钥</label>
		<div id="passwordDiv">
			<label for="password">Password:</label><input type="password" id="password"/><br>
		</div>
		<div id="sshKeyDiv">
			<label for="sshKey">SshKey:</label><textarea id="sshKey" rows="2"></textarea><input id="sshKeyFile" type="file" onchange="changeFile()"><br>
		</div>



		<button onclick="save()">Save</button>
	</div>
	<div id="sessions" hidden>
		<ul id="sessionsul" style="margin-block-start: 0;margin-block-end: 0;">
		</ul>
	</div>

	<div id="terminal"></div>

	<script>

		const server_admin_url = "http://10.0.0.136:8888/admin";
		const server_ws_url = "ws://10.0.0.136:8888/ws";
		let term;
		let socket;

		function openAdd() {
			const node = $('#add');
			if(node.is(':hidden')){　　//如果node是隐藏的则显示node元素，否则隐藏
				node.show();
				$('#sessions').hide();
			}else{
				node.hide();
			}
		}

		function openSession() {
			const node = $('#sessions');
			if(node.is(':hidden')){　　//如果node是隐藏的则显示node元素，否则隐藏
				node.show();
				$('#add').hide();
				list();
			}else{
				node.hide();
			}
		}

		function changeFile(){
			debugger
			let files = $('#sshKeyFile').prop('files');
			if(!files || !files[0]){
				return;
			}
			let f = files[0];
			let reader = new FileReader(); //新建一个FileReader
			reader.readAsText(f, "UTF-8"); //读取文件
			reader.onload = function (evt) { //读取完文件之后会回来这里
				let fileString = evt.target.result;
				$('#sshKey').val(fileString);
			}
		}

		function changeType(type) {
			if(type === 1){
				$('#passwordDiv').show();
				$('#sshKeyDiv').hide();
			}else if(type === 2){
				$('#sshKeyDiv').show();
				$('#passwordDiv').hide();
			}

		}

		function save() {
			let address=$('#address').val();
			let username=$("#username").val();
			let password=$('#password').val();
			let sshKey=$('#sshKey').val();
			let alias=$('#alias').val();
			$.post(server_admin_url + "/add",{
				address: address,
				username: username,
				password: password,
				name: alias,
				sshKey: sshKey,
			},function(result){
				$('#add').hide();
				if(result && result.id){
					connect(result.id)
				}
			});
		}

		function del(id) {
			$.post(server_admin_url + "/del",{
				id: id,
			},function(result){
				list();
			});
		}

		function list() {
			$.get(server_admin_url + "/list", function(result){
				if(!result || !result.sessions){
					return;
				}
				$('#sessionsul').empty();
				for(let i in result.sessions){
					let session = result.sessions[i];
					let sessionHtml = '<li><a style="cursor:pointer" onclick="connect('+session.Id+')">'+session.Name+'('+session.Username+'@'+session.Address+')</a><button onclick="connect('+session.Id+')">Connect</button><button onclick="del('+session.Id+')">del</button></li>';
					$("#sessionsul").append(sessionHtml);
				}
			});
		}

		function connect(id) {
			$('#sessions').hide();
			if(term){
				//term.dispose();
			}
			if(socket){
				socket.close();
			}

			socket = new WebSocket(server_ws_url+'/'+id);

			socket.onopen = function () {

				let window_width = $(window).width();
				let window_height = $(window).height();
				let cols = Math.floor(window_width/10);
				let rows = Math.floor(window_height/19);
				term = new Terminal(
						{
							cols: cols,
							rows: rows,
							useStyle:false,
							convertEol: true,
							cursorBlink:true,
							cursorStyle:null,
						});
				term.open(document.getElementById('terminal'));

				term.onData(send => socket.send(send));
				socket.onmessage = function (msg) {
					console.log(msg);
					handleParseBlob(msg.data,function (content) {
						term.write(content);
					})
				};
				socket.onerror = function (e) {
					debugger
					console.log(e);
				};
				socket.onclose = function (e) {
					console.log(e);
					//term.clear();
					term.dispose();
				};


			};
		}

		function handleParseBlob(b,callback) {

			if (typeof b === 'object') {
				zsentry.consume(b);
			}

			var reader = new FileReader();
			reader.onload = function(event){
				callback(reader.result);
			};
			reader.readAsText(b);
		}

		//init
		$('input:radio[name=type]')[0].checked = true;
		changeType(1);

		////===========







	</script>
</body>
</html>
